(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{817:function(e,t,o){var content=o(828);"string"==typeof content&&(content=[[e.i,content,""]]),content.locals&&(e.exports=content.locals);(0,o(48).default)("51da29e9",content,!0,{sourceMap:!1})},827:function(e,t,o){"use strict";var r=o(817);o.n(r).a},828:function(e,t,o){(t=o(47)(!1)).push([e.i,".room_list-enter-active[data-v-50bb3d12],.room_list-leave-active[data-v-50bb3d12]{transition:all .5s}.room_list-enter[data-v-50bb3d12],.room_list-leave-to[data-v-50bb3d12]{opacity:0;transform:translateX(30px)}",""]),e.exports=t},856:function(e,t,o){"use strict";o.r(t);o(62),o(15),o(29);var r=o(6),n=(o(28),{head:function(){return{title:"房间列表 - Saiblo"}},data:function(){return{web_socket:null,server:{open:!1,timeout:null,closing:!1},rooms:[],room_creator:{open:!1,is_loading:!1,is_ok:!1,room:{game:2,capacity:null,is_private:!1,password:""}},room_selector_id:null}},computed:{filtered_rooms:function(){var e=this;return-1==this.game.id?this.rooms:this.rooms.filter((function(t){return t.game.id==e.game.id}))},room_creator_capacity_options:function(){return this.getGameById(this.room_creator.room.game).capacity_options}},watch:{"server.value":function(){this.initWebSocket()},"room_creator.room.game":function(e){this.room_creator.room.capacity=this.getGameById(e).capacity_options[0].value}},asyncData:function(e){var t={id:-1,options:[{value:-1,text:"所有游戏"}]},o={value:null,options:[]};return e.app.$axios.get("/api/games/").then((function(r){return r.data.forEach((function(element){element.capacity_options=[];for(var e=0;e<element.player_number.length;e++){var o=element.player_number[e];element.capacity_options.push({value:o,text:"".concat(o)})}t.options.push({value:element.id,text:"".concat(element.alias,"(").concat(element.name,")")})})),e.app.$axios.get("/api/servers/").then((function(e){for(var n=0;n<e.data.length;n++){var element=e.data[n];o.options.push({value:element.address,text:element.description,label:{color:"green",empty:!0,circular:!0}}),o.value=element.address}return{game:t,games:r.data,server:o}}))}))},mounted:function(){this.initWebSocket(),this.room_creator.room.game=1},beforeDestroy:function(){this.clearWebSocket()},methods:{clearWebSocket:function(){var e=this;return Object(r.a)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!==e.server.timeout&&(clearTimeout(e.server.timeout),e.server.timeout=null),null===e.web_socket){t.next=11;break}return e.server.open=!1,e.server.closing=!0,t.next=6,e.web_socket.close();case 6:if(!e.server.closing){t.next=11;break}return t.next=9,new Promise((function(e){return setTimeout(e,10)}));case 9:t.next=6;break;case 11:case"end":return t.stop()}}),t)})))()},initWebSocket:function(){var e=this;return Object(r.a)(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.server.value){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,e.clearWebSocket();case 4:e.server.open=!0,e.room_creator.is_loading=!1,e.web_socket=new WebSocket("wss://".concat(e.server.value)),e.web_socket.onopen=e.webSocketOnOpen,e.web_socket.onmessage=e.webSocketOnMessage,e.web_socket.onclose=function(){e.web_socket=null,e.server.open&&(e.server.timeout=setTimeout((function(){e.initWebSocket()}),3e3)),e.server.closing=!1};case 10:case"end":return t.stop()}}),t)})))()},webSocketOnOpen:function(){this.sendMessage(JSON.stringify({type:"get_room_list"}))},webSocketOnMessage:function(e){var data=JSON.parse(e.data);switch(data.type){case"push_room_list":this.loadRoomList(data);break;case"room_created":this.joinRoom(Number(data.room),!0)}},sendMessage:function(data){return null===this.web_socket||1!==this.web_socket.readyState?(this.$notify.warning({title:"失败",message:"服务器尚未连接",timeout:2e3}),!1):(this.web_socket.send(data),!0)},getGameById:function(e){for(var t=0;t<this.games.length;t++){var o=this.games[t];if(o.id==e)return o}},loadRoomList:function(data){var e=this;return Object(r.a)(regeneratorRuntime.mark((function t(){var o,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(e.rooms=[],o=0;o<data.room.length;o++)r=data.room[o],e.rooms.push({id:r.id,is_private:r.private,game:e.getGameById(r.game),players:r.users});case 2:case"end":return t.stop()}}),t)})))()},createRoom:function(){this.room_creator.room.capacity?this.sendMessage(JSON.stringify({type:"create_room",user:this.$auth.$state.user,game:this.getGameById(this.room_creator.room.game),capacity:this.room_creator.room.capacity,private:this.room_creator.room.is_private}))&&(this.room_creator.is_loading=!0):this.$notify.warning({title:"失败",message:"人数不能为空",timeout:2e3})},joinRoom:function(e,t){if(t)this.$router.push("/room/".concat(e,"?server=").concat(this.server.value));else{for(var o=0;o<this.rooms.length;o++){if(this.rooms[o].id==e)return void this.$router.push("/room/".concat(e,"?server=").concat(this.server.value))}this.$notify.error({title:"失败",message:"没有这个房间",timeout:3e3})}}}}),c=(o(827),o(7)),component=Object(c.a)(n,(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",[o("sui-grid",{staticStyle:{"margin-left":"-1em !important","margin-right":"-1em !important"},attrs:{stackable:""}},[o("sui-grid-row",[o("sui-grid-column",[o("sui-header",{tag:"h1"},[e._v("房间列表")])],1)],1),e._v(" "),o("sui-grid-row",{staticClass:"f",staticStyle:{"flex-direction":"row-reverse"}},[o("sui-grid-column",{attrs:{width:4}},[o("sui-form",[o("sui-form-field",[o("sui-message",{class:"f sa",staticStyle:{"margin-bottom":"0","border-bottom-left-radius":"0","border-bottom-right-radius":"0"},attrs:{size:"mini"}},[e.web_socket&&1==e.web_socket.readyState?o("div",[e._v("\n                已连接服务器\n              ")]):e.web_socket&&0==e.web_socket.readyState?o("div",[e._v("\n                正在连接服务器\n              ")]):o("div",[e._v("未连接服务器")])]),e._v(" "),o("sui-progress",{attrs:{attached:"",state:"active",percent:"100",color:e.web_socket?1==e.web_socket.readyState?"green":0==e.web_socket.readyState?"yellow":"grey":"grey"}})],1),e._v(" "),o("sui-form-field",[o("sui-dropdown",{attrs:{fluid:"",selection:"",options:e.server.options,placeholder:"服务器"},model:{value:e.server.value,callback:function(t){e.$set(e.server,"value",t)},expression:"server.value"}})],1),e._v(" "),o("sui-form-field",[o("sui-dropdown",{attrs:{fluid:"",selection:"",options:e.game.options,placeholder:"游戏"},model:{value:e.game.id,callback:function(t){e.$set(e.game,"id",t)},expression:"game.id"}})],1),e._v(" "),o("sui-form-field",[o("div",{staticClass:"ui action input"},[o("input",{directives:[{name:"model",rawName:"v-model",value:e.room_selector_id,expression:"room_selector_id"}],staticStyle:{width:"0"},attrs:{placeholder:"输入房间号"},domProps:{value:e.room_selector_id},on:{input:function(t){t.target.composing||(e.room_selector_id=t.target.value)}}}),e._v(" "),o("sui-button",{attrs:{color:"green",disabled:!e.web_socket||1!=e.web_socket.readyState},on:{click:function(t){return t.preventDefault(),e.joinRoom(e.room_creator_id,!1)}}},[e._v("加入")])],1)]),e._v(" "),o("sui-form-field",[o("sui-button",{attrs:{color:"blue",fluid:"",disabled:null===e.web_socket||1!==e.web_socket.readyState},on:{click:function(t){t.preventDefault(),e.room_creator.open=!0}}},[e._v("创建房间")])],1)],1)],1),e._v(" "),o("sui-grid-column",{attrs:{width:12}},[0==e.filtered_rooms.length?o("sui-message",{attrs:{icon:"exclamation",header:"没有找到房间",content:"请创建房间或更改搜索房间号",info:""}}):e._e(),e._v(" "),e.filtered_rooms.length>0?o("sui-table",{attrs:{striped:""}},[o("sui-table-header",[o("sui-table-row",[o("sui-table-header-cell",{attrs:{collapsing:""}}),e._v(" "),o("sui-table-header-cell",{staticStyle:{width:"6em"}},[e._v("游戏")]),e._v(" "),o("sui-table-header-cell",{staticStyle:{width:"5em"}},[e._v("房间号")]),e._v(" "),o("sui-table-header-cell",[e._v("玩家")]),e._v(" "),o("sui-table-header-cell",{staticStyle:{width:"6em"}})],1)],1),e._v(" "),o("transition-group",{attrs:{tag:"sui-table-body",name:"room_list"}},e._l(e.filtered_rooms,(function(t){return o("sui-table-row",{key:t.id},[o("sui-table-cell",[t.is_private?o("sui-icon",{staticStyle:{"margin-right":"-0.8em"},attrs:{name:"lock",color:"grey"}}):e._e()],1),e._v(" "),o("sui-table-cell",[o("nuxt-link",{attrs:{to:"/game/"+t.game.id}},[e._v(e._s(t.game.alias))])],1),e._v(" "),o("sui-table-cell",[e._v(e._s(t.id))]),e._v(" "),o("sui-table-cell",e._l(t.players,(function(e,t){return o("div",{key:t,staticClass:"ib",staticStyle:{"margin-right":"2em"}},[o("sui-image",{attrs:{avatar:"",src:"https://cdn.v2ex.com/gravatar/"+e.mail_md5+"?s=1000&d=mm"}}),o("player-card",{attrs:{username:e.username}})],1)})),0),e._v(" "),o("sui-table-cell",[o("sui-button",{attrs:{size:"mini",color:"green"},on:{click:function(o){return o.preventDefault(),e.joinRoom(t.id,!1)}}},[e._v("加入")])],1)],1)})),1)],1):e._e()],1)],1)],1),e._v(" "),o("sui-modal",{attrs:{size:"mini"},model:{value:e.room_creator.open,callback:function(t){e.$set(e.room_creator,"open",t)},expression:"room_creator.open"}},[o("sui-modal-header",[e._v("创建房间")]),e._v(" "),o("sui-modal-content",[o("sui-form",[o("sui-form-field",[o("label",[e._v("选择游戏")]),e._v(" "),o("sui-dropdown",{attrs:{placeholder:"选择游戏",selection:"",fuild:"",options:e.game.options.slice(1)},model:{value:e.room_creator.room.game,callback:function(t){e.$set(e.room_creator.room,"game",t)},expression:"room_creator.room.game"}})],1),e._v(" "),o("sui-form-field",[o("label",[e._v("人数")]),e._v(" "),o("sui-dropdown",{attrs:{placeholder:"选择人数",selection:"",fluid:"",options:e.room_creator_capacity_options},model:{value:e.room_creator.room.capacity,callback:function(t){e.$set(e.room_creator.room,"capacity",t)},expression:"room_creator.room.capacity"}})],1),e._v(" "),o("sui-form-field",{attrs:{hidden:""}},[o("label",{staticClass:"f ce"},[o("span",{staticStyle:{"margin-right":"1em"}},[e._v("是否私密")]),e._v(" "),o("input",{directives:[{name:"model",rawName:"v-model",value:e.room_creator.room.is_private,expression:"room_creator.room.is_private"}],attrs:{type:"checkbox"},domProps:{checked:Array.isArray(e.room_creator.room.is_private)?e._i(e.room_creator.room.is_private,null)>-1:e.room_creator.room.is_private},on:{change:function(t){var o=e.room_creator.room.is_private,r=t.target,n=!!r.checked;if(Array.isArray(o)){var c=e._i(o,null);r.checked?c<0&&e.$set(e.room_creator.room,"is_private",o.concat([null])):c>-1&&e.$set(e.room_creator.room,"is_private",o.slice(0,c).concat(o.slice(c+1)))}else e.$set(e.room_creator.room,"is_private",n)}}})]),e._v(" "),o("transition",{attrs:{name:"slide"}},[o("div",{directives:[{name:"show",rawName:"v-show",value:e.room_creator.room.is_private,expression:"room_creator.room.is_private"}]},[o("input",{attrs:{placeholder:"输入房间密码",type:"password"}})])])],1)],1)],1),e._v(" "),o("sui-modal-actions",[o("sui-button",{attrs:{color:"blue",loading:e.room_creator.is_loading},on:{click:function(t){return t.preventDefault(),e.createRoom()}}},[e._v("创建")])],1)],1)],1)}),[],!1,null,"50bb3d12",null);t.default=component.exports}}]);